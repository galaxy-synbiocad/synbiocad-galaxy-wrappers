<tool id="rpFBA" name="FBA" version="5.1.4">
    <description>Perform FBA for the RetroPath2.0 heterologous pathways</description>
	<requirements>
        <requirement type="package" version="5.1.4">rptools</requirement>
    </requirements>
    <stdio>
        <regex match="WARNING" level="warning" />
        <regex match="ERROR"   level="fatal" />
    </stdio>
    <command detect_errors="exit_code"><![CDATA[
	    python -m rptools.rpfba '$pathway' '$model' '$compartment_id' '$output'
			#if str($adv.dont_merge) == "false":
				--merge
			#end if
				--pathway_id '$adv.pathway_id'
				--objective_id '$adv.objective_id'
				--target_reaction '$input_sim_type.target_reaction'
				--target_coefficient '$input_sim_type.target_coefficient'
				--sim '$input_sim_type.sim_type'
			#if str($adv.is_max) == "true":
				--is_max
			#end if
				--log '$adv.log_level'
			#if str($input_sim_type.sim_type)=="fraction"
				--source_coefficient '$input_sim_type.source_coefficient'
				--source_reaction '$input_sim_type.source_reaction'
				--fraction_of '$input_sim_type.fraction_of'
			#end if
			#if str($input_sim_type.sim_type)=="pfba"
				--source_coefficient 0
				--source_reaction ''
				--fraction_of '$input_sim_type.fraction_of'
			#end if
			#if str($input_sim_type.sim_type)=="fba"
				--source_coefficient 0
				--source_reaction ''
				--fraction_of 0.0
			#end if
    ]]></command>
    <inputs>
		<param name="pathway" type="data" format="xml" label="Pathway (rpSBML)" />
		<param name="model"   type="data" format="xml" label="Model (SBML)" />
        <param name="compartment_id" type="text" label="SBML compartment ID" value="MNXC3" />
        <conditional name="input_sim_type">
            <param name="sim_type"     type="select" label="Constraint based simulation type">
                <option value="fraction" type="text" selected="true">Fraction of Reaction</option>
                <option value="fba"      type="text">FBA</option>
                <option value="pfba"     type="text">Parsimonious FBA</option>
            </param>
			<when value="fraction">
				<param name="fraction_of"        type="float" value="0.75"       label="Fraction of the source reaction" />
				<param name="target_reaction"    type="text"  value="rxn_target" label="Target reaction" />
				<param name="source_coefficient" type="float" value="1.0"        label="Target coefficient" />
				<param name="source_reaction"    type="text"  value="biomass"    label="Source reaction" />
				<param name="target_coefficient" type="float" value="1.0"        label="Source coefficient" />
			</when>
			<when value="pfba">
				<param name="fraction_of"        type="float" value="0.95"       label="Fraction of optimal" />
				<param name="target_reaction"    type="text"  value="rxn_target" label="Target reaction" />
				<param name="target_coefficient" type="float" value="1.0"        label="Target coefficient" />
			</when>
			<when value="fba">
				<param name="target_reaction"    type="text"  value="rxn_target" label="Target reaction" />
				<param name="target_coefficient" type="float" value="1.0"        label="Target coefficient" />
			</when>
        </conditional>
		<section name="adv" title="Advanced Options" expanded="false">
			<param name="pathway_id"     type="text"    label="Name of the heterologous pathway"     value="rp_pathway" />
			<param name="objective_id"   type="text"    label="Overwrite default given objective ID" value="obj_fraction" />
			<param name="is_max"         type="boolean" label="Maximise the objective?"              checked="true" />
			<param name="dont_merge"     type="boolean" label="Don't output the merged model?"       checked="true"   display="checkboxes" />
			<param name="log_level"      type="select"  label="Log level">
                <option value="debug"    type="text"                >debug</option>
                <option value="info"     type="text"                >info</option>
			    <option value="warning"  type="text"                >warning</option>
			    <option value="error"    type="text" selected="true">error</option>
			    <option value="critical" type="text"                >critical</option>
            </param>
		</section>
    </inputs>
    <outputs>
        <data name="output" format="xml" label="${tool.name} - ${input_sim_type.sim_type} - ${pathway.name}" />
    </outputs>
    <help><![CDATA[
FBA
=====


Flux balance analysis is a mathematical approach for analyzing the flow of metabolites through a metabolic network. It is performed for heterologous pathways generated by RetroPath2.0. The tool performs the following steps:

- Merges a user-defined GEM SBML model with each given heterologous pathway individually.
- Performs FBA using the CobraPy package. Three different analysis methods are proposed; two of which are native CobraPy methods - standard FBA and Parsimonious FBA, the other one proposed is an in-house analysis method named "Fraction of Reaction".

The "Fraction of Reaction" method involves performing FBA using the "Source Reaction" as the objective function (by default the biomass reaction is specified, which refers to the rate at which all of the biomass precursors are made in the correct proportions). Then the flux of that reaction has its upper and lower bounds set to the same value, determined as a "Fraction of the source reaction" (default is 75% of its optimum). Thereafter, the objective is set to the target reaction followed by performing FBA once again. The tool uses the FBC package to manage the objective and flux bounds.
For the first two, the user must specify the name(s) of reaction(s) that the model will optimize to, while for the latter the user must provide the target reaction but also another source reaction that will be restricted.
Using the Advanced Options, the user can specify the name of the heterologous pathway as created by "Pathways to SBML" and the compartment ID of the heterologous pathway. The user may obtain a merged version of the resulting model, or the heterologous pathway only using the "Don't output the merged model" boolean parameter. Using the "Maximize the Objective?", the user may choose to maximize or minimize the objective (biomass production in this case) in the model.

NOTE: In order to FBA works correctly, some of chemical species have to be ignored. These species are selected according to the following criteria:

- pathway species has not been found in the model (neither by its ID nor its InChIKey),
- the species is not the target, and
- the species is only consumed or produced with the heterologue pathway.

.. image:: https://raw.githubusercontent.com/Galaxy-SynBioCAD/rpFBA/standalone/galaxy/img/rpFBA.png
	:width: 60 %
	:align: center

|

The above figure illustrates the steps in the tool's calculation of FBA. The pathway is merged with a GEM SBML model and using the FBC package and CobraPy FBA is performed and the fluxes saved to the SBML file.

Input
-----

Required:


* **-pathway**\ : (string) SBML file that contains an heterologous pathway
* **-model**\ : (string) Path to the GEM SBML model
* **-compartment_id**\ : (string) Model compartment id (e.g. 'c' or 'MNXC3')

Advanced options:


* **--pathway_id**\ : (string, default=rp_pathway) ID of the heterologous pathway
* **--sim**\ : (string, default=fraction) Valid options include: fraction, fba, pfba. The type of constraint based modelling method
* **--source_reaction**\ : (string, default=biomass) Name of the source reaction that will be restricted in the "fraction" simulation type. This parameter is ignored for "fba" and "pfba"
* **--target_reaction**\ : (string, default=RP1_sink) Heterologous pathway flux sink reaction. This parameters is required in all simulation type
* **--source_coefficient**\ : (float, default=1.0) Objective coefficient for the source reaction. This parameter is ignored for "fba" and "pfba"
* **--target_coefficient**\ : (float, default=1.0) Objective coefficient for the target reaction.
* **--is_max**\ : (boolean, default=True) Maximise or minimise the objective function
* **--fraction_of**\ : (float, default=0.75) Portion of the maximal flux used to set the maximal and minimal bounds for the source reaction of the "fraction" simulation type
* **--merge**\ : (boolean, default=False) output the full merged model instead of heterologous pathway only
* **--log**: (string, default=error) Set the log level, choices are 'debug', 'info', 'warning', 'error', 'critical'

Output
------

* **output**\ : (string) Path to the output file

Project Links
---------------------

* `GitHub <https://github.com/Galaxy-SynBioCAD/rpFBA>`_

Version
----------

0.1

Authors
-------

* **Melchior du Lac**
* **Joan HÃ©risson**

License
-------

`MIT <https://raw.githubusercontent.com/Galaxy-SynBioCAD/rpFBA/standalone-dev/LICENSE>`_

Acknowledgments
---------------


* Thomas Duigou
    ]]></help>
    <citations>
        <citation type="bibtex">
@article{hucka2016sbml,
  title={SBML Level 3 package: Groups, Version 1 Release 1},
  author={Hucka, Michael and Smith, Lucian P},
  journal={Journal of integrative bioinformatics},
  volume={13},
  number={3},
  pages={8--29},
  year={2016},
  publisher={De Gruyter}
}
        </citation>
        <citation type="bibtex">
@article{ebrahim2013cobrapy,
  title={COBRApy: COnstraints-based reconstruction and analysis for python},
  author={Ebrahim, Ali and Lerman, Joshua A and Palsson, Bernhard O and Hyduke, Daniel R},
  journal={BMC systems biology},
  volume={7},
  number={1},
  pages={74},
  year={2013},
  publisher={Springer}
}
        </citation>
    </citations>
</tool>